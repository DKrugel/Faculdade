---
title: "Trabalho 4"
author: "Daniel Krügel"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(highcharter)
library(hrbrthemes)
library(car)
library(mcprofile)
library(xtable)
library(gtsummary)
library(plotly)
```

Estarei testando o pacote `gtsummary` para criar as tabelas deste trabalho, portanto deixarei todos os chunks de códigos com `echo = TRUE`.

# Questão 13

## a)

A população de inferência é a população que frequenta o starbucks no período das 8:00 até as 8:30, a amostra foi quem frequenta o starbucks de Lincoln, NE.

## b)

```{r, include = F}
starbucks = read.csv( file = "http://leg.ufpr.br/~lucambio/ADC/starbucks.csv" )

```

```{r gráfico}
starbucks$Day <- factor(starbucks$Day, 
                        levels = c('Monday',"Tuesday","Wednesday","Thursday","Friday"))

starbucks %>% 
  ggplot(aes(x = Day, y = Count)) +
  geom_bar(stat = "identity", color = "black") + 
  theme(
  panel.background = element_rect(fill = "lightgrey",
                                colour = "lightgrey",
                                linewidth = 0.5, linetype = "solid"),
  panel.grid.major = element_line(linewidth = 0.5, linetype = 'solid',
                                colour = "white"), 
  panel.grid.minor = element_line(linewidth = 0.25, linetype = 'solid',
                                colour = "white"))
```

## c)

```{r modelo }
fit1 <- glm(Count ~ Day, 
            family = poisson(link='log'),
            data = starbucks)
```

```{r sumário, echo=TRUE}
fit1 %>% 
  tbl_regression(add_estimate_to_reference_rows = F) %>% 
  add_q()
```

O pacote omitiu o intercepto, já pedi para ele exponenciar os coeficientes pois foi utilizado a função log, o valor do intercepto, que equivale a segunda-feira, é `r fit1$coefficients[1]`

## I)

Lembrando que usamos a função de ligação log, então para conseguir as estimativas diárias precisamos passar um exponencial nos coeficientes.

```{r exp coef, echo=TRUE}
fit1 %>% 
  tbl_regression(exponentiate = T) %>% 
  add_global_p()
```

## II)

```{r Anova Aparente}
xtable(Anova(fit1)) 
```

Utilizando o pacote no qual estou aprendendo a usar, o valor do teste LR é omitido, porém o p-valor é exibido a cada covariável.

```{r}
fit1 %>% 
  tbl_regression() %>% 
  add_global_p()
```


```{r Anova silenciosa, include=FALSE}
nova <- Anova(fit1)
```

O Teste LR demonstrou que a variável `Day` é relevante para a contagem de pessoas presentes no Starbucks com um P-valor de `r nova[,3]`

## III)

## IV)

Aqui temos a média estimada para cada dia da semana

```{r média estimada}
quart <- summary(starbucks$Count)
quart[4]*fit1$coefficients[1:5]
```

E aqui vemos a média observada em cada dia da semana

```{r média observada}
starbucks %>% 
  group_by(Day) %>% 
  reframe(total = mean(Count))
```

Os intervalos de confiança para a média de cada dia da semana:

```{r Intervalo de confianca}
K <- matrix(data = c(1*quart[4], 0, 0, 0, 0,
                     0, 1*quart[4], 0, 0, 0,
                     0, 0, 1*quart[4], 0, 0,
                     0, 0, 0, 1*quart[4], 0,
                     0, 0, 0, 0, 1*quart[4]), nrow = 5, ncol = 5, byrow = TRUE)
linear.combo <- mcprofile(object = fit1, CM = K)
ci.beta <- confint(object = linear.combo, level = 0.95)
Estimativas <- ci.beta$confint
rownames(Estimativas) <- c("Segunda","Terça","Quarta","Quinta","Sexta")
Estimativas
```

## d)

Ambas as formas de escrita do teste de hipóteses descrevem um modelo linear de variáveis, porém quando levado para modelos lineares generalizados precisamos levar em conta a função de ligação utilizada no modelo. Como utilizamos a função canônica de ligação para o GLM da família Poisson, sua link é a Função logarítmica, o que deve de ser levado a diante no teste de razões LRT seria algo como:

$$
H_0: e^\mu_1 = e^\mu_2 = e^\mu_3 = e^\mu_4 = e^\mu_5
$$

$$
H_1: \mu \neq \mu \neq \mu \neq \mu \neq \mu
$$
